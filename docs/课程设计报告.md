# 《数据库应用》课程设计报告

## 项目名称：聚香园餐厅点餐系统

---

## 1 需求分析

### 1.1 项目背景

一家名为"聚香园"的中餐厅，拥有大厅圆桌和包间。餐厅需要一套系统支持顾客入座后扫码点餐，支持加菜、退菜，并能管理桌台的占用情况。

### 1.2 用户角色分析

系统包含四类用户角色：

| 角色 | 角色说明 |
|------|----------|
| 顾客（Customer） | 餐厅就餐顾客，扫码绑定桌号进行点餐 |
| 服务员（Waiter） | 餐厅服务人员，协助点餐、确认订单、处理退菜、结账 |
| 后厨（Chef） | 厨房工作人员，查看分单并制作菜品 |
| 经理（Manager） | 餐厅管理人员，管理菜品和查看营收统计 |

### 1.3 功能需求描述

#### （1）顾客功能

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| C01 | 查看空闲桌位 | 查看桌位ID、桌台类型、桌台容量、桌台状态 |
| C02 | 扫码绑定桌位 | 开台，将桌台状态从"空闲"变为"就餐中"，并关联新订单 |
| C03 | 查看菜单 | 查看菜品ID、菜品名称、菜品分类、菜品价格及口味选项 |
| C04 | 点菜/加菜 | 选择菜品、口味选项、数量，加入当前订单 |
| C05 | 查看当前订单明细 | 查看订单ID、菜品信息、数量等 |
| C06 | 催菜 | 对未制作或制作中的菜品进行催菜 |

#### （2）服务员功能

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| W01 | 查看全部桌位 | 查看所有桌位的状态信息 |
| W02 | 管理桌位状态 | 将"待清理"状态的桌台变更为"空闲" |
| W03 | 开台 | 将桌台状态从"空闲"变为"就餐中"，创建账单和订单 |
| W04 | 查看菜单 | 查看在售菜品信息 |
| W05 | 协助点菜/加菜 | 帮助顾客点菜，选择菜品、口味、数量 |
| W06 | 查看当前订单明细 | 查看待确认订单的菜品明细 |
| W07 | 确认订单 | 将订单提交给后厨制作 |
| W08 | 退菜 | 对未制作或制作中的菜品进行退菜，需填写退菜理由 |
| W09 | 结账 | 汇总账单、选择折扣（八折/抹零）、结算并更新桌台状态 |

#### （3）后厨功能

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| K01 | 查看所有下单 | 查看所有已确认订单的菜品明细 |
| K02 | 查看分单 | 凉菜房（凉菜、酒水）、热菜房（热菜、汤羹、主食） |
| K03 | 更新菜品状态 | 将菜品状态从未制作→制作中→已完成 |

#### （4）经理功能

| 功能编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| M01 | 查看所有菜品 | 查看菜品ID、名称、分类、价格、口味选项 |
| M02 | 添加菜品 | 添加菜品信息及口味选项配置 |
| M03 | 下架菜品 | 永久删除菜品及其口味选项 |
| M04 | 营收统计 | 汇总所有账单及明细，统计总额与实际消费额 |

### 1.4 数据需求

需要持久化存储的数据实体：

| 数据实体 | 说明 |
|---------|------|
| 桌台信息 | 桌位ID、桌台类型、容量、状态 |
| 菜品信息 | 菜品ID、名称、分类、价格、上架状态 |
| 口味轮次 | 关联菜品、轮次序号、轮次名称 |
| 口味选项 | 关联轮次、选项名称 |
| 账单信息 | 账单ID、关联桌位、总额、实付额、折扣类型、状态 |
| 订单信息 | 订单ID、关联桌位、关联账单、状态 |
| 订单明细 | 明细ID、关联订单、菜品、数量、单价、口味选择、制作状态 |

---

## 2 开发环境说明

### 2.1 所采用的技术栈

| 类别 | 技术/工具 | 版本 |
|------|----------|------|
| 数据库系统 | Supabase (PostgreSQL) | 云数据库 |
| 后端语言 | Python | 3.8+ |
| Web框架 | Flask | 3.0+ |
| 前端技术 | HTML5 + CSS3 + JavaScript | - |
| 开发工具 | VS Code / Cursor | 最新版 |
| 数据库设计工具 | Supabase SQL Editor | 在线 |

### 2.2 详细配置

#### （1）数据库配置

```
数据库类型：PostgreSQL（通过Supabase云平台托管）
项目URL：https://xxymbnbqsebwonbxxcrr.supabase.co
认证方式：service_role key
```

#### （2）Python依赖

```
supabase>=2.0.0          # Supabase Python客户端
flask>=3.0.0             # Web框架
flask-cors>=4.0.0        # 跨域支持
httpx>=0.25.0            # HTTP请求库
python-dotenv>=1.0.0     # 环境变量管理
tabulate>=0.9.0          # 表格美化输出
colorama>=0.4.6          # 控制台颜色
```

#### （3）系统架构

```
采用B/S架构（Browser/Server）：
├── 前端：HTML + CSS + JavaScript（浏览器端）
├── 后端：Flask（Python Web服务器）
└── 数据库：Supabase（PostgreSQL云数据库）
```

---

## 3 概念结构设计

### 3.1 实体识别

根据需求分析，识别出以下核心实体：

| 实体名称 | 英文名称 | 说明 |
|---------|---------|------|
| 桌台 | Table | 餐厅的用餐桌位 |
| 菜品 | Dish | 餐厅提供的菜品 |
| 口味轮次 | FlavorRound | 菜品的口味选择轮次 |
| 口味选项 | FlavorOption | 具体的口味选项 |
| 账单 | Bill | 一次就餐的总账单 |
| 订单 | Order | 单次点菜形成的订单 |
| 订单明细 | OrderItem | 订单中的具体菜品项 |

### 3.2 实体关系图（ER图）

```
┌─────────┐       1:N       ┌─────────┐
│  Table  │────────────────>│  Bill   │
│  桌台   │                 │  账单   │
└─────────┘                 └─────────┘
     │                           │
     │ 1:N                       │ 1:N
     ▼                           ▼
┌─────────┐       N:1       ┌─────────┐
│  Order  │<────────────────│  Order  │
│  订单   │                 │  订单   │
└─────────┘                 └─────────┘
     │
     │ 1:N
     ▼
┌───────────┐      N:1      ┌─────────┐
│ OrderItem │──────────────>│  Dish   │
│ 订单明细  │               │  菜品   │
└───────────┘               └─────────┘
                                 │
                                 │ 1:N
                                 ▼
                           ┌────────────┐
                           │FlavorRound │
                           │ 口味轮次   │
                           └────────────┘
                                 │
                                 │ 1:N
                                 ▼
                           ┌─────────────┐
                           │FlavorOption │
                           │  口味选项   │
                           └─────────────┘
```

### 3.3 实体属性定义

#### （1）桌台（Table）
- 桌位ID（主键）
- 桌台类型（大厅圆桌/包间）
- 容量
- 状态（空闲/就餐中/待清理）

#### （2）菜品（Dish）
- 菜品ID（主键）
- 菜品名称
- 菜品分类（热菜/凉菜/汤羹/主食/酒水）
- 价格
- 是否上架

#### （3）口味轮次（FlavorRound）
- 轮次ID（主键）
- 菜品ID（外键）
- 轮次序号
- 轮次名称

#### （4）口味选项（FlavorOption）
- 选项ID（主键）
- 轮次ID（外键）
- 选项名称

#### （5）账单（Bill）
- 账单ID（主键）
- 桌位ID（外键）
- 总额
- 实付额
- 折扣类型
- 状态
- 创建时间
- 结账时间

#### （6）订单（Order）
- 订单ID（主键）
- 桌位ID（外键）
- 账单ID（外键）
- 状态（未确认/已确认）
- 创建时间

#### （7）订单明细（OrderItem）
- 明细ID（主键）
- 订单ID（外键）
- 菜品ID（外键）
- 数量
- 下单时单价
- 口味选择（JSON）
- 菜品状态（未制作/制作中/已完成/已退菜）
- 是否催菜
- 退菜理由
- 创建时间

---

## 4 逻辑结构设计

### 4.1 关系模式

根据概念模型，设计如下关系模式：

```
tables(table_id, table_type, capacity, status)
    主键：table_id
    约束：table_type ∈ {'大厅圆桌', '包间'}
         status ∈ {'空闲', '就餐中', '待清理'}

dishes(dish_id, dish_name, category, price, is_available)
    主键：dish_id
    约束：category ∈ {'热菜', '凉菜', '汤羹', '主食', '酒水'}
         price >= 0

flavor_rounds(round_id, dish_id, round_number, round_name)
    主键：round_id
    外键：dish_id → dishes(dish_id) ON DELETE CASCADE
    约束：(dish_id, round_number) 唯一

flavor_options(option_id, round_id, option_name)
    主键：option_id
    外键：round_id → flavor_rounds(round_id) ON DELETE CASCADE

bills(bill_id, table_id, total_amount, actual_amount, discount_type, status, created_at, settled_at)
    主键：bill_id
    外键：table_id → tables(table_id)
    约束：discount_type ∈ {'八折', '抹零', NULL}
         status ∈ {'未结账', '已结账'}

orders(order_id, table_id, bill_id, status, created_at)
    主键：order_id
    外键：table_id → tables(table_id)
         bill_id → bills(bill_id)
    约束：status ∈ {'未确认', '已确认'}

order_items(item_id, order_id, dish_id, quantity, unit_price, flavor_choices, dish_status, is_rushed, refund_reason, created_at)
    主键：item_id
    外键：order_id → orders(order_id) ON DELETE CASCADE
         dish_id → dishes(dish_id)
    约束：quantity > 0
         dish_status ∈ {'未制作', '制作中', '已完成', '已退菜'}
```

### 4.2 范式分析

所有关系模式均满足第三范式（3NF）：

| 表名 | 范式等级 | 分析说明 |
|------|---------|---------|
| tables | 3NF | 所有非主属性完全函数依赖于主键，无传递依赖 |
| dishes | 3NF | 所有非主属性完全函数依赖于主键，无传递依赖 |
| flavor_rounds | 3NF | 所有非主属性完全函数依赖于主键，无传递依赖 |
| flavor_options | 3NF | 所有非主属性完全函数依赖于主键，无传递依赖 |
| bills | 3NF | 所有非主属性完全函数依赖于主键，无传递依赖 |
| orders | 3NF | 所有非主属性完全函数依赖于主键，无传递依赖 |
| order_items | 3NF | unit_price冗余存储用于记录下单时价格，属于合理的反规范化 |

### 4.3 外键关系

```
flavor_options.round_id → flavor_rounds.round_id (CASCADE)
flavor_rounds.dish_id → dishes.dish_id (CASCADE)
order_items.order_id → orders.order_id (CASCADE)
order_items.dish_id → dishes.dish_id
orders.table_id → tables.table_id
orders.bill_id → bills.bill_id
bills.table_id → tables.table_id
```

---

## 5 物理结构设计

### 5.1 表汇总

| 表名 | 功能说明 |
|------|---------|
| tables | 餐厅桌台信息表，存储桌位基本信息和状态 |
| dishes | 菜品信息表，存储菜品名称、分类、价格等 |
| flavor_rounds | 口味轮次表，存储菜品关联的口味选择轮次 |
| flavor_options | 口味选项表，存储每轮次的具体选项 |
| bills | 账单表，存储每次就餐的账单信息 |
| orders | 订单表，存储每次点菜的订单信息 |
| order_items | 订单明细表，存储订单中的具体菜品项 |

### 5.2 表 tables（桌台表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| table_id | SERIAL | 非空 | PRIMARY KEY |
| table_type | VARCHAR(20) | 非空 | CHECK (table_type IN ('大厅圆桌', '包间')) |
| capacity | INTEGER | 非空 | CHECK (capacity > 0) |
| status | VARCHAR(20) | 非空 | DEFAULT '空闲', CHECK (status IN ('空闲', '就餐中', '待清理')) |

补充说明：大厅圆桌容量为6人，包间容量为12人

### 5.3 表 dishes（菜品表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| dish_id | SERIAL | 非空 | PRIMARY KEY |
| dish_name | VARCHAR(100) | 非空 | - |
| category | VARCHAR(20) | 非空 | CHECK (category IN ('热菜', '凉菜', '汤羹', '主食', '酒水')) |
| price | DECIMAL(10,2) | 非空 | CHECK (price >= 0) |
| is_available | BOOLEAN | 非空 | DEFAULT TRUE |

补充说明：is_available用于软删除，下架菜品时设为FALSE

### 5.4 表 flavor_rounds（口味轮次表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| round_id | SERIAL | 非空 | PRIMARY KEY |
| dish_id | INTEGER | 非空 | FOREIGN KEY → dishes(dish_id) ON DELETE CASCADE |
| round_number | INTEGER | 非空 | CHECK (round_number > 0) |
| round_name | VARCHAR(50) | 非空 | - |

补充说明：UNIQUE(dish_id, round_number) 确保每个菜品的轮次序号唯一

### 5.5 表 flavor_options（口味选项表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| option_id | SERIAL | 非空 | PRIMARY KEY |
| round_id | INTEGER | 非空 | FOREIGN KEY → flavor_rounds(round_id) ON DELETE CASCADE |
| option_name | VARCHAR(50) | 非空 | - |

补充说明：级联删除确保删除菜品时自动删除关联的口味选项

### 5.6 表 bills（账单表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| bill_id | SERIAL | 非空 | PRIMARY KEY |
| table_id | INTEGER | 非空 | FOREIGN KEY → tables(table_id) |
| total_amount | DECIMAL(10,2) | 非空 | DEFAULT 0 |
| actual_amount | DECIMAL(10,2) | 非空 | DEFAULT 0 |
| discount_type | VARCHAR(20) | 可空 | CHECK (discount_type IN ('八折', '抹零', NULL)) |
| status | VARCHAR(20) | 非空 | DEFAULT '未结账', CHECK (status IN ('未结账', '已结账')) |
| created_at | TIMESTAMP | 非空 | DEFAULT CURRENT_TIMESTAMP |
| settled_at | TIMESTAMP | 可空 | - |

补充说明：total_amount为折扣前总额，actual_amount为折扣后实付金额

### 5.7 表 orders（订单表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| order_id | SERIAL | 非空 | PRIMARY KEY |
| table_id | INTEGER | 非空 | FOREIGN KEY → tables(table_id) |
| bill_id | INTEGER | 可空 | FOREIGN KEY → bills(bill_id) |
| status | VARCHAR(20) | 非空 | DEFAULT '未确认', CHECK (status IN ('未确认', '已确认')) |
| created_at | TIMESTAMP | 非空 | DEFAULT CURRENT_TIMESTAMP |

补充说明：未确认订单尚未提交后厨，确认后移交后厨制作

### 5.8 表 order_items（订单明细表）

| 列名 | 数据类型（精度范围） | 空/非空 | 约束条件 |
|------|---------------------|---------|---------|
| item_id | SERIAL | 非空 | PRIMARY KEY |
| order_id | INTEGER | 非空 | FOREIGN KEY → orders(order_id) ON DELETE CASCADE |
| dish_id | INTEGER | 非空 | FOREIGN KEY → dishes(dish_id) |
| quantity | INTEGER | 非空 | CHECK (quantity > 0) |
| unit_price | DECIMAL(10,2) | 非空 | - |
| flavor_choices | TEXT | 可空 | JSON格式存储 |
| dish_status | VARCHAR(20) | 非空 | DEFAULT '未制作', CHECK (...) |
| is_rushed | BOOLEAN | 非空 | DEFAULT FALSE |
| refund_reason | TEXT | 可空 | - |
| created_at | TIMESTAMP | 非空 | DEFAULT CURRENT_TIMESTAMP |

补充说明：unit_price记录下单时价格，避免菜品涨价影响已点订单；flavor_choices使用JSON格式如 '[{"轮次":"辣度","选项":"微辣"}]'

---

## 6 数据库编程与权限

### 6.1 数据库建库、建表、数据导入

#### （1）建表SQL语句

```sql
-- 1. 桌台表
CREATE TABLE tables (
    table_id SERIAL PRIMARY KEY,
    table_type VARCHAR(20) NOT NULL CHECK (table_type IN ('大厅圆桌', '包间')),
    capacity INTEGER NOT NULL CHECK (capacity > 0),
    status VARCHAR(20) NOT NULL DEFAULT '空闲' CHECK (status IN ('空闲', '就餐中', '待清理'))
);

-- 2. 菜品表
CREATE TABLE dishes (
    dish_id SERIAL PRIMARY KEY,
    dish_name VARCHAR(100) NOT NULL,
    category VARCHAR(20) NOT NULL CHECK (category IN ('热菜', '凉菜', '汤羹', '主食', '酒水')),
    price DECIMAL(10, 2) NOT NULL CHECK (price >= 0),
    is_available BOOLEAN NOT NULL DEFAULT TRUE
);

-- 3. 口味轮次表
CREATE TABLE flavor_rounds (
    round_id SERIAL PRIMARY KEY,
    dish_id INTEGER NOT NULL REFERENCES dishes(dish_id) ON DELETE CASCADE,
    round_number INTEGER NOT NULL CHECK (round_number > 0),
    round_name VARCHAR(50) NOT NULL,
    UNIQUE(dish_id, round_number)
);

-- 4. 口味选项表
CREATE TABLE flavor_options (
    option_id SERIAL PRIMARY KEY,
    round_id INTEGER NOT NULL REFERENCES flavor_rounds(round_id) ON DELETE CASCADE,
    option_name VARCHAR(50) NOT NULL
);

-- 5. 账单表
CREATE TABLE bills (
    bill_id SERIAL PRIMARY KEY,
    table_id INTEGER NOT NULL REFERENCES tables(table_id),
    total_amount DECIMAL(10, 2) NOT NULL DEFAULT 0,
    actual_amount DECIMAL(10, 2) NOT NULL DEFAULT 0,
    discount_type VARCHAR(20) CHECK (discount_type IN ('八折', '抹零', NULL)),
    status VARCHAR(20) NOT NULL DEFAULT '未结账' CHECK (status IN ('未结账', '已结账')),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    settled_at TIMESTAMP
);

-- 6. 订单表
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    table_id INTEGER NOT NULL REFERENCES tables(table_id),
    bill_id INTEGER REFERENCES bills(bill_id),
    status VARCHAR(20) NOT NULL DEFAULT '未确认' CHECK (status IN ('未确认', '已确认')),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 7. 订单明细表
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(order_id) ON DELETE CASCADE,
    dish_id INTEGER NOT NULL REFERENCES dishes(dish_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10, 2) NOT NULL,
    flavor_choices TEXT,
    dish_status VARCHAR(20) NOT NULL DEFAULT '未制作' CHECK (dish_status IN ('未制作', '制作中', '已完成', '已退菜')),
    is_rushed BOOLEAN NOT NULL DEFAULT FALSE,
    refund_reason TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### （2）创建索引

```sql
CREATE INDEX idx_tables_status ON tables(status);
CREATE INDEX idx_dishes_category ON dishes(category);
CREATE INDEX idx_dishes_available ON dishes(is_available);
CREATE INDEX idx_orders_table_id ON orders(table_id);
CREATE INDEX idx_orders_bill_id ON orders(bill_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_dish_status ON order_items(dish_status);
CREATE INDEX idx_order_items_is_rushed ON order_items(is_rushed);
CREATE INDEX idx_bills_table_id ON bills(table_id);
CREATE INDEX idx_bills_status ON bills(status);
```

#### （3）数据导入示例

```sql
-- 导入桌台数据
INSERT INTO tables (table_type, capacity, status) VALUES
('大厅圆桌', 6, '空闲'),
('大厅圆桌', 6, '空闲'),
('包间', 12, '空闲');

-- 导入菜品数据
INSERT INTO dishes (dish_name, category, price) VALUES
('水煮肉片', '热菜', 58.00),
('宫保鸡丁', '热菜', 42.00),
('可乐', '酒水', 8.00);

-- 导入口味选项
INSERT INTO flavor_rounds (dish_id, round_number, round_name) VALUES
(1, 1, '辣度'),
(1, 2, '油度');

INSERT INTO flavor_options (round_id, option_name) VALUES
(1, '微辣'), (1, '中辣'), (1, '特辣'),
(2, '少油'), (2, '正常油');
```

### 6.2 程序模块

#### （1）数据库连接模块

```python
from supabase import create_client, Client

SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_KEY = "your-service-role-key"

def get_client() -> Client:
    """获取Supabase客户端实例"""
    return create_client(SUPABASE_URL, SUPABASE_KEY)
```

#### （2）核心数据库操作

```python
# 查询空闲桌台
def get_available_tables():
    client = get_client()
    result = client.table("tables").select("*").eq("status", "空闲").execute()
    return result.data

# 开台操作
def open_table(table_id):
    client = get_client()
    # 更新桌台状态
    client.table("tables").update({"status": "就餐中"}).eq("table_id", table_id).execute()
    # 创建账单
    bill = client.table("bills").insert({"table_id": table_id}).execute()
    # 创建订单
    order = client.table("orders").insert({
        "table_id": table_id, 
        "bill_id": bill.data[0]["bill_id"]
    }).execute()
    return bill.data[0], order.data[0]

# 添加订单明细
def add_order_item(order_id, dish_id, quantity, unit_price, flavor_choices):
    client = get_client()
    result = client.table("order_items").insert({
        "order_id": order_id,
        "dish_id": dish_id,
        "quantity": quantity,
        "unit_price": unit_price,
        "flavor_choices": flavor_choices
    }).execute()
    return result.data[0]

# 结账操作
def checkout(table_id, discount_type):
    client = get_client()
    bill = client.table("bills").select("*").eq("table_id", table_id).eq("status", "未结账").execute().data[0]
    
    # 计算总额
    orders = client.table("orders").select("*").eq("bill_id", bill["bill_id"]).execute().data
    total = 0
    for order in orders:
        items = client.table("order_items").select("*").eq("order_id", order["order_id"]).neq("dish_status", "已退菜").execute().data
        for item in items:
            total += item["unit_price"] * item["quantity"]
    
    # 计算折扣
    if discount_type == "八折":
        actual = total * 0.8
    elif discount_type == "抹零":
        actual = int(total)
    else:
        actual = total
    
    # 更新账单
    client.table("bills").update({
        "total_amount": total,
        "actual_amount": actual,
        "discount_type": discount_type,
        "status": "已结账",
        "settled_at": datetime.now().isoformat()
    }).eq("bill_id", bill["bill_id"]).execute()
    
    # 更新桌台状态
    client.table("tables").update({"status": "待清理"}).eq("table_id", table_id).execute()
```

#### （3）视图定义

```sql
-- 后厨凉菜房视图
CREATE VIEW v_kitchen_cold AS
SELECT oi.*, o.order_id, o.table_id, d.dish_name, d.category
FROM order_items oi
JOIN orders o ON oi.order_id = o.order_id
JOIN dishes d ON oi.dish_id = d.dish_id
WHERE o.status = '已确认'
  AND d.category IN ('凉菜', '酒水')
  AND oi.dish_status != '已退菜'
ORDER BY oi.is_rushed DESC, o.created_at ASC;

-- 后厨热菜房视图
CREATE VIEW v_kitchen_hot AS
SELECT oi.*, o.order_id, o.table_id, d.dish_name, d.category
FROM order_items oi
JOIN orders o ON oi.order_id = o.order_id
JOIN dishes d ON oi.dish_id = d.dish_id
WHERE o.status = '已确认'
  AND d.category IN ('热菜', '汤羹', '主食')
  AND oi.dish_status != '已退菜'
ORDER BY oi.is_rushed DESC, o.created_at ASC;
```

### 6.3 角色与权限

| 角色 | 可以访问的表与列 | 操作权限 |
|------|-----------------|---------|
| 顾客 | tables(全部列) | SELECT |
| | dishes(全部列) | SELECT |
| | flavor_rounds(全部列) | SELECT |
| | flavor_options(全部列) | SELECT |
| | orders(全部列) | SELECT, INSERT |
| | order_items(全部列) | SELECT, INSERT, UPDATE(is_rushed) |
| 服务员 | tables(全部列) | SELECT, UPDATE(status) |
| | dishes(全部列) | SELECT |
| | orders(全部列) | SELECT, INSERT, UPDATE |
| | order_items(全部列) | SELECT, INSERT, UPDATE |
| | bills(全部列) | SELECT, INSERT, UPDATE |
| 后厨 | orders(全部列) | SELECT |
| | order_items(全部列) | SELECT, UPDATE(dish_status) |
| | dishes(dish_id, dish_name, category) | SELECT |
| 经理 | 全部表 | ALL（完全权限） |

---

## 7 实施与优化

### 7.1 优化措施

| 优先级 | 优化对象（目标） | 措施 |
|-------|-----------------|------|
| 高 | 订单查询速度 | 在order_items表的order_id、dish_status列创建索引 |
| 高 | 后厨分单查询 | 在dishes表的category列创建索引，使用视图预过滤 |
| 中 | 桌台状态查询 | 在tables表的status列创建索引 |
| 中 | 催菜订单优先显示 | 在order_items表的is_rushed列创建索引，查询时优先排序 |
| 低 | 订单金额记录 | 在order_items中冗余存储unit_price，避免菜品改价后重新计算 |

### 7.2 反规范化设计

| 反规范化项 | 说明 | 目的 |
|-----------|------|------|
| order_items.unit_price | 存储下单时的菜品价格 | 保证历史订单金额准确，即使菜品涨价也不受影响 |
| order_items.flavor_choices | JSON格式存储口味选择 | 简化查询，避免多表关联 |

### 7.3 索引设计

```sql
-- 高频查询索引
CREATE INDEX idx_tables_status ON tables(status);           -- 查询空闲桌位
CREATE INDEX idx_orders_status ON orders(status);           -- 查询已确认订单
CREATE INDEX idx_order_items_dish_status ON order_items(dish_status);  -- 后厨查询
CREATE INDEX idx_order_items_is_rushed ON order_items(is_rushed);      -- 催菜优先
CREATE INDEX idx_bills_status ON bills(status);             -- 查询未结账账单
```

---

## 8 系统开发与实现

### 8.1 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      浏览器（前端）                      │
│   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│   │ 顾客端  │ │服务员端 │ │ 后厨端  │ │ 经理端  │     │
│   └─────────┘ └─────────┘ └─────────┘ └─────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼ HTTP API
┌─────────────────────────────────────────────────────────┐
│                   Flask Web服务器                        │
│                     (app.py)                             │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼ Supabase Client
┌─────────────────────────────────────────────────────────┐
│               Supabase (PostgreSQL云数据库)              │
└─────────────────────────────────────────────────────────┘
```

### 8.2 系统运行界面

#### （1）首页 - 角色选择

访问 http://localhost:5000 进入系统首页，选择用户角色。

#### （2）顾客端

- 选择空闲桌位开台
- 浏览菜单，选择口味下单
- 查看当前订单，催菜功能

#### （3）服务员端

- 左侧显示所有桌位状态
- 可进行开台、点菜、确认订单、退菜、结账操作
- 结账时可选择八折或抹零优惠

#### （4）后厨端

- 分为凉菜房和热菜房两个工作站
- 催菜订单高亮显示并优先排序
- 可更新菜品制作状态

#### （5）经理端

- 菜品管理：查看、添加、下架菜品
- 营收统计：账单明细、总额汇总

---

## 9 系统源代码说明

### 9.1 文件结构

```
order/
├── app.py                      # Flask Web应用主程序
├── main.py                     # 控制台版主程序
├── config.py                   # 数据库配置文件
├── requirements.txt            # Python依赖
├── database/
│   ├── schema.sql             # 数据库表结构DDL
│   └── init_data.sql          # 初始测试数据
├── src/
│   ├── __init__.py
│   ├── database.py            # 数据库操作模块
│   ├── utils.py               # 工具函数模块
│   ├── customer.py            # 顾客功能模块
│   ├── waiter.py              # 服务员功能模块
│   ├── chef.py                # 后厨功能模块
│   └── manager.py             # 经理功能模块
├── templates/                  # HTML模板
│   ├── index.html             # 首页
│   ├── base.html              # 基础模板
│   ├── customer.html          # 顾客端
│   ├── waiter.html            # 服务员端
│   ├── chef.html              # 后厨端
│   └── manager.html           # 经理端
└── static/                     # 静态资源
    ├── css/style.css          # 样式表
    └── js/
        ├── common.js          # 公共JS
        ├── customer.js        # 顾客端JS
        ├── waiter.js          # 服务员端JS
        ├── chef.js            # 后厨端JS
        └── manager.js         # 经理端JS
```

### 9.2 核心文件说明

| 文件 | 说明 |
|------|------|
| app.py | Flask Web应用，提供RESTful API接口 |
| database/schema.sql | 数据库DDL脚本，包含7张表、11个索引、4个视图 |
| database/init_data.sql | 初始数据，包含15张桌台、32个菜品、完整口味配置 |
| src/database.py | 数据库操作封装，提供CRUD接口 |
| static/js/*.js | 前端交互逻辑，通过API与后端通信 |

### 9.3 运行方式

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置数据库（编辑config.py）
SUPABASE_URL = "your-project-url"
SUPABASE_KEY = "your-service-role-key"

# 3. 在Supabase执行SQL脚本
# - 先执行 database/schema.sql
# - 再执行 database/init_data.sql

# 4. 启动Web应用
python app.py

# 5. 访问系统
# 浏览器打开 http://localhost:5000
```
